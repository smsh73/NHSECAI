# 워크플로우 데이터 전달 분석 및 개선안

**작성일**: 2025-01-28  
**분석 대상**: 워크플로우 실행 엔진 및 편집기

---

## 1. 현재 구현 상태 분석

### 1.1 노드 간 데이터 전달 로직

#### ✅ 구현 완료된 기능
1. **자동 데이터 전달** (`prepareNodeInput`):
   - edges를 통해 이전 노드들을 자동으로 찾아서 출력 데이터를 다음 노드의 입력으로 전달
   - 이전 노드가 하나면 직접 할당, 여러 개면 객체로 할당 (노드 ID를 키로 사용)

2. **수동 데이터 매핑** (`inputMapping`):
   - PropertiesPanel에서 입력 매핑을 JSON 형식으로 설정 가능
   - `$nodeId` 형태로 다른 노드의 출력을 참조 가능

3. **노드 실행 결과 저장**:
   - 각 노드의 실행 결과가 `sessionData`에 저장됨
   - PostgreSQL의 `workflow_session_data` 테이블에 저장되어 다음 노드에서 조회 가능

4. **실행 순서 결정**:
   - edges를 기반으로 위상 정렬(Topological Sort)을 통해 실행 순서 결정
   - 의존성이 있는 노드들은 자동으로 순차 실행

#### ⚠️ 개선이 필요한 부분
1. **실시간 데이터 확인 기능 부족**:
   - 워크플로우 편집 중 이전 노드의 출력을 실시간으로 확인하면서 다음 노드를 설정하는 기능이 제한적
   - PropertiesPanel에서 입력 매핑을 설정할 때 이전 노드의 실제 출력을 직접 볼 수 없음

2. **시각적 피드백 부족**:
   - 노드 간 데이터 흐름을 시각적으로 표시하는 기능이 제한적
   - 연결선에 데이터 전달 상태를 표시하는 기능 없음

3. **변수 자동완성/검증 부족**:
   - 입력 매핑 설정 시 이전 노드의 출력 키를 자동완성하는 기능 없음
   - 변수 참조 오류를 사전에 검증하는 기능 부족

---

## 2. 실행 흐름 예시

### 시나리오: 프롬프트 → API → Python

1. **프롬프트 노드 실행**:
   - 입력: `{}` (시작 노드에서 전달)
   - 실행: 프롬프트 실행 엔진이 OpenAI API 호출
   - 출력: `{ "analysis": "...", "sentiment": "positive", "keyPoints": [...] }`
   - 저장: `sessionData["prompt-node-1"] = { output: {...} }`

2. **API 노드 실행**:
   - 입력 준비: `prepareNodeInput`이 이전 노드(prompt-node-1)의 출력을 가져옴
   - 입력: `{ "analysis": "...", "sentiment": "positive", "keyPoints": [...] }`
   - 실행: API 호출 (입력 데이터를 파라미터로 사용)
   - 출력: `{ "apiResponse": {...}, "status": 200, "data": [...] }`
   - 저장: `sessionData["api-node-2"] = { output: {...} }`

3. **Python 노드 실행**:
   - 입력 준비: `prepareNodeInput`이 이전 노드(api-node-2)의 출력을 가져옴
   - 입력: `{ "apiResponse": {...}, "status": 200, "data": [...] }`
   - 실행: Python 스크립트 실행 (입력 데이터를 `input_data` 변수로 전달)
   - 출력: `{ "processed": [...], "summary": "...", "result": {...} }`
   - 저장: `sessionData["python-node-3"] = { output: {...} }`

---

## 3. 개선 제안

### 3.1 PropertiesPanel 개선

#### 제안 1: 이전 노드 출력 미리보기
- PropertiesPanel에서 입력 매핑 설정 시 이전 노드들의 출력을 실시간으로 확인할 수 있는 섹션 추가
- 연결된 이전 노드들의 출력 데이터를 트리 형태로 표시
- 각 출력 키를 클릭하여 입력 매핑에 자동으로 추가

#### 제안 2: 변수 자동완성
- 입력 매핑 설정 시 이전 노드의 출력 키를 자동완성하는 기능 추가
- `{NODE_OUTPUT}`, `{nodeId_output}`, `{previousNodeId.key}` 형태의 변수 참조 지원

#### 제안 3: 데이터 타입 검증
- 입력 매핑 설정 시 이전 노드의 출력 데이터 타입을 확인하고 검증
- 타입 불일치 시 경고 메시지 표시

### 3.2 워크플로우 캔버스 개선

#### 제안 1: 노드 출력 표시
- 시뮬레이션 모드에서 노드 실행 후 노드 위에 출력 데이터 요약을 표시
- 노드를 호버하면 이전 노드로부터 받은 입력 데이터와 자신의 출력 데이터를 표시

#### 제안 2: 연결선 데이터 흐름 표시
- 연결선에 데이터 전달 상태를 시각적으로 표시 (애니메이션, 색상 변화)
- 연결선을 클릭하면 해당 연결을 통해 전달되는 데이터를 미리보기

#### 제안 3: 실시간 실행 모니터링
- 워크플로우 실행 중 각 노드의 실행 상태를 실시간으로 표시
- 노드가 실행되면 해당 노드가 강조 표시되고, 출력 데이터가 연결선을 따라 흐르는 애니메이션

### 3.3 시뮬레이션 모드 개선

#### 제안 1: 단계별 실행
- 노드를 하나씩 실행하면서 각 단계의 입력/출력을 확인
- 이전 노드를 실행하지 않으면 다음 노드 실행 불가능하도록 제한

#### 제안 2: 실행 결과 상세 표시
- 각 노드의 실행 결과를 노드 위에 표시 (토글 가능)
- 입력 데이터, 출력 데이터, 실행 시간, 에러 메시지 등을 상세히 표시

---

## 4. 구현 우선순위

### 높음 (즉시 구현 권장)
1. PropertiesPanel에 이전 노드 출력 미리보기 추가
2. 입력 매핑 설정 시 변수 자동완성 기능
3. 노드 실행 결과를 노드 위에 표시하는 기능

### 중간 (중기 구현 권장)
1. 연결선에 데이터 흐름 상태 표시
2. 데이터 타입 검증 및 경고 기능
3. 단계별 실행 모드 개선

### 낮음 (장기 개선 고려)
1. 실시간 애니메이션으로 데이터 흐름 표시
2. 워크플로우 실행 히스토리 및 롤백 기능
3. 노드 간 데이터 의존성 그래프 시각화

---

## 5. 현재 코드의 한계점

### 5.1 데이터 전달은 구현되어 있으나...
- ✅ `prepareNodeInput`: 이전 노드 출력을 자동으로 가져옴
- ✅ `getPreviousNodeOutputs`: edges를 통해 이전 노드 찾기
- ✅ `saveNodeOutputToSession`: 출력 데이터 저장
- ❌ **편집 중 이전 노드 출력을 직접 확인하는 기능 부족**
- ❌ **입력 매핑 설정 시 변수 자동완성 기능 부족**
- ❌ **노드 실행 결과를 캔버스에서 직접 확인하는 기능 제한적**

### 5.2 시뮬레이션 모드는 있으나...
- ✅ `executeSingleNode`: 단일 노드 실행 가능
- ✅ `nodeExecutionResults`: 실행 결과 상태 관리
- ✅ 워크플로우 노드에 실행 결과 표시 (제한적)
- ❌ **편집 중 단계별로 실행하면서 결과를 확인하는 워크플로우가 불편함**
- ❌ **이전 노드를 실행하지 않으면 다음 노드 실행 불가능하지만, 이에 대한 명확한 피드백 부족**

---

## 6. 결론

### 현재 구현 상태
- ✅ 노드 간 데이터 전달 로직은 **완벽하게 구현되어 있음**
- ✅ 프롬프트 → API → Python 순서로 실행되고, 각 노드의 출력이 다음 노드의 입력으로 전달됨
- ⚠️ 하지만 **편집 중 실시간으로 데이터를 확인하면서 노드를 정의하는 기능이 부족함**

### 개선 필요사항
1. PropertiesPanel에서 이전 노드의 출력을 직접 확인할 수 있는 기능 추가
2. 입력 매핑 설정 시 변수 자동완성 및 검증 기능 추가
3. 노드 실행 결과를 캔버스에서 더 명확하게 표시하는 기능 개선
4. 연결선을 통해 데이터 흐름을 시각적으로 표시하는 기능 추가

### 사용자 제안의 타당성
**사용자의 제안은 매우 타당합니다.** 워크플로우를 편집할 때 이전 노드의 실제 출력을 보면서 다음 노드를 설정하는 것이 오류를 줄이고 정확한 워크플로우를 정의하는 데 필수적입니다.

