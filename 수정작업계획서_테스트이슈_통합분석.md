# 수정 작업 계획서 - 테스트 이슈 통합 분석

## 문서 개요

본 문서는 테스트 결과를 바탕으로 URL/테스트 화면별로 분류하여 체계적인 수정 작업 계획을 수립합니다.

**작성일**: 2025년 11월 4일  
**대상 환경**: https://app-was-int-dev.azurewebsites.net/  
**분석 범위**: 총 20개 화면, 50개 이상 이슈

---

## 요구사항 및 현황 분석

### 현황
- **환경**: Azure App Service (개발 환경)
- **주요 문제 유형**:
  1. API 에러 (500, 404)
  2. 데이터베이스 제약 조건 위반 (Foreign Key)
  3. UI/UX 문제 (드래그 불가, 검색 기능)
  4. 워크플로우 실행 오류
  5. 데이터 동기화 문제
  6. 노드 타입 미지원 오류

### 목표
1. 모든 에러 해결 (500, 404, Foreign Key 등)
2. UI/UX 개선 (텍스트 선택, 드래그, 검색 기능)
3. 워크플로우 안정성 향상
4. 데이터 일관성 보장

---

## 핵심 개선 포인트 도출

### 1순위: 크리티컬 에러 (즉시 수정 필요)
- **스케줄러 시작 500 에러**: 중지 후 즉시 시작 시 실패
- **Dictionary Foreign Key 위반**: 새 항목 추가 불가
- **워크플로우 AI 분석 노드 실행 실패**: AIApiService2 미존재 오류
- **워크플로우 노드 타입 미지원**: theme_classifier, alert 타입 처리 누락
- **API 호출 관리 404 에러**: 파라미터 누락

### 2순위: 기능 개선 (우선 수정)
- **테마 클러스터 관리**: 생성/수정 불가, 데이터 불일치
- **워크플로우 노드 저장**: 입력/출력 형식 저장 안됨
- **종료 노드 Databricks 저장**: gold 스키마 저장 기능 부재
- **TextInput 드래그/선택**: 전체 선택 및 드래그 불가

### 3순위: UX 개선 (점진적 개선)
- **검색 기능 개선**: 키워드 검색 정확도 향상
- **알림창 자동 닫기**: 수동 닫기 번거로움 해소
- **대화내역 복사 기능**: 드래그 불가 대안 제공

---

## 솔루션 시나리오 제안

### Phase 1: 크리티컬 에러 수정 (1주)

#### 1단계: 스케줄러 시작 500 에러 수정
**목표**: 스케줄러 중지 후 즉시 시작 시 발생하는 500 에러 해결

**현황 분석**:
- `server/routes.ts`의 `/api/scheduler/start` 엔드포인트에서 100ms 대기 후 시작
- `schedulerService.startScheduler()` 호출 시 내부 상태가 완전히 정리되지 않을 수 있음

**개선 방안**:
1. `schedulerService.stopScheduler()`에서 완전한 정리 확인 로직 추가
2. 대기 시간을 100ms에서 500ms로 증가
3. 시작 전 상태 확인 로직 추가 (isActive, jobs 상태 검증)
4. 재시도 로직 추가 (최대 3회, 지수 백오프)

**예상 파일**:
- `server/routes.ts` (라인 5617-5647)
- `server/services/scheduler.ts` (라인 195-262)

**기대 효과**: 스케줄러 시작 실패율 100% → 0%로 감소

---

#### 2단계: Dictionary Foreign Key 위반 수정
**목표**: Dictionary 항목 추가 시 Foreign Key 제약 조건 위반 에러 해결

**현황 분석**:
- `server/storage.ts`의 `createDictionaryEntry()`에서 dictionary 존재 여부 확인
- 에러 메시지가 영어로만 표시되어 사용자 이해 어려움
- dictionaryId가 유효하지 않을 때 에러 처리 미흡

**개선 방안**:
1. Dictionary ID 유효성 검증 강화 (존재 여부, 활성화 상태 확인)
2. 에러 메시지 한글화 및 상세화
3. 프론트엔드에서 Dictionary 선택 시 유효한 ID만 전송하도록 검증 추가
4. 에러 발생 시 사용자에게 어떤 Dictionary ID가 문제인지 명확히 표시

**예상 파일**:
- `server/storage.ts` (라인 8639-8658)
- `client/src/pages/dictionary-manager.tsx`

**기대 효과**: Dictionary 항목 추가 성공률 0% → 100%로 향상

---

#### 3단계: 워크플로우 AI 분석 노드 실행 실패 수정
**목표**: AI 분석 노드 실행 시 "AIApiService2.callAIService is not a function" 에러 해결

**현황 분석**:
- `server/services/workflow-execution-engine.ts`의 `executeAiAnalysisNode()`에서 `AIApiService` 사용
- 에러 메시지에서 `AIApiService2`를 찾으려고 함 → 실제로는 `AIApiService` 클래스 사용
- 에러 메시지가 잘못된 함수명을 참조하고 있을 가능성

**개선 방안**:
1. `executeAiAnalysisNode()` 함수에서 `AIApiService` import 확인
2. `AIApiService2` 참조가 있다면 `AIApiService`로 변경
3. 함수 호출 방식 확인: `AIApiService.callAzureOpenAIChat()` 정상 호출 확인
4. 에러 핸들링 개선: 실제 에러 원인을 정확히 캡처

**예상 파일**:
- `server/services/workflow-execution-engine.ts` (라인 633-678)

**기대 효과**: AI 분석 노드 실행 성공률 0% → 100%로 향상

---

#### 4단계: 워크플로우 노드 타입 미지원 오류 수정
**목표**: theme_classifier, alert 노드 타입 실행 시 "지원하지 않는 노드 타입" 에러 해결

**현황 분석**:
- `server/services/workflow-execution-engine.ts`의 `executeNode()` 함수에서 노드 타입별 switch 문 처리
- `theme_classifier`, `alert` 케이스는 존재하지만 (라인 562-571), 다른 곳에서 미지원 에러 발생 가능성

**개선 방안**:
1. `executeNode()` 함수의 switch 문에 모든 노드 타입 케이스 확인
2. `client/src/types/workflow.ts`의 노드 타입 정의와 서버 실행 로직 일치 확인
3. 미지원 노드 타입 에러 발생 위치 확인 및 수정
4. 노드 타입 추가 시 클라이언트와 서버 동시 업데이트 가이드 작성

**예상 파일**:
- `server/services/workflow-execution-engine.ts` (라인 440-594)
- `client/src/types/workflow.ts` (라인 1-55)

**기대 효과**: theme_classifier, alert 노드 실행 성공률 0% → 100%로 향상

---

#### 5단계: API 호출 관리 404 에러 수정
**목표**: `/api/api-calls/enhanced?` 호출 시 404 에러 해결

**현황 분석**:
- `client/src/pages/api-management.tsx`에서 `testApiCall()` 함수 호출 시 API ID 파라미터 누락
- `server/routes.ts`의 `/api/api-calls/:id/test` 엔드포인트는 API ID 필수

**개선 방안**:
1. `testApiCall()` 함수 호출 시 API ID 파라미터 전달 확인
2. API ID가 없을 때 사용자에게 안내 메시지 표시
3. API 테스트 버튼 클릭 전 API 선택 여부 검증
4. 에러 메시지 개선: "API ID를 선택해주세요" 등 명확한 안내

**예상 파일**:
- `client/src/pages/api-management.tsx` (라인 59-2489)
- `server/routes.ts` (라인 914-941)

**기대 효과**: API 테스트 성공률 향상, 사용자 경험 개선

---

### Phase 2: 주요 기능 개선 (2주)

#### 6단계: 테마 클러스터 관리 생성/수정 불가 수정
**목표**: 테마 생성 및 수정 기능 정상 동작

**현황 분석**:
- `client/src/pages/theme-cluster-management.tsx`에서 테마 생성/수정 시 필수 필드 검증 로직 존재
- `server/storage.ts`의 `createTheme()`, `updateTheme()` 함수 확인 필요
- 데이터 불일치: 카드와 상세 내용 값이 다름

**개선 방안**:
1. 테마 생성 API 엔드포인트 확인 및 수정
2. 필수 필드 검증 강화 (name, themeType 등)
3. 테마 수정 시 기존 데이터 유지 로직 확인
4. 카드와 상세 내용 데이터 소스 통일 (동일한 API 호출 사용)
5. 새로고침 문제: WebSocket 이벤트로 인한 무한 새로고침 방지

**예상 파일**:
- `client/src/pages/theme-cluster-management.tsx` (라인 1-1212)
- `server/storage.ts` (라인 4881-4948)
- `server/routes.ts` (테마 관련 엔드포인트)

**기대 효과**: 테마 생성/수정 성공률 0% → 100%로 향상, 데이터 일관성 보장

---

#### 7단계: 워크플로우 노드 입력/출력 형식 저장 개선
**목표**: 노드의 입력/출력 형식 입력 후 저장이 정상 동작하도록 개선

**현황 분석**:
- `client/src/components/workflow/properties-panel.tsx`에서 입력/출력 형식 입력 UI 존재
- `client/src/pages/workflow-editor.tsx`의 `handleNodeUpdate()` 함수에서 저장 로직 확인 필요
- 저장 후 다른 노드 클릭 시 초기화되는 문제

**개선 방안**:
1. 노드 업데이트 시 입력/출력 형식 필드 포함 확인
2. 저장 로직에서 데이터베이스 업데이트 확인
3. 노드 로드 시 저장된 입력/출력 형식 복원 로직 확인
4. 자동 저장 로직 개선 (2초 지연 → 즉시 저장 또는 사용자 저장 버튼)

**예상 파일**:
- `client/src/pages/workflow-editor.tsx` (라인 549-588)
- `client/src/components/workflow/properties-panel.tsx` (라인 24-1578)
- `server/routes.ts` (워크플로우 노드 업데이트 엔드포인트)

**기대 효과**: 노드 설정 저장 성공률 향상, 사용자 경험 개선

---

#### 8단계: 종료 노드 Databricks gold 스키마 저장 기능 구현
**목표**: 워크플로우 결과 데이터를 Databricks gold 스키마에 저장

**현황 분석**:
- `server/services/workflow-execution-engine.ts`의 `executeNode()` 함수에서 'end' 케이스 처리
- `saveWorkflowResultToDatabricks()` 함수 호출은 있지만 구현 확인 필요
- 테이블명: `nh_ai.gold.{workflowId}`
- Description: `{workflowName} - {workflowDescription}`
- 스키마: 결과 데이터의 스키마 추출하여 동일하게 구성

**개선 방안**:
1. `saveWorkflowResultToDatabricks()` 함수 구현
2. 결과 데이터 스키마 추출 로직 구현 (JSON 스키마 추론)
3. Databricks Unity Catalog API를 사용한 테이블 생성
4. 테이블 Description 설정 로직 구현
5. 데이터 삽입 로직 구현 (기존 테이블이 있으면 업데이트 또는 스키마 변경)

**예상 파일**:
- `server/services/workflow-execution-engine.ts` (라인 483-502)
- `server/services/databricks-service.ts` (Databricks 연동 서비스)

**기대 효과**: 워크플로우 결과 데이터 영구 저장, 데이터 분석 가능성 확대

---

#### 9단계: TextInput 드래그/선택 기능 개선
**목표**: TextInput 영역에서 텍스트 드래그 및 Ctrl+A 전체 선택 가능

**현황 분석**:
- `client/src/components/ui/input.tsx`, `client/src/components/ui/textarea.tsx`에 이미 `user-select: text` 설정 존재
- `onKeyDown` 핸들러에서 Ctrl+A 처리 로직 존재
- 실제로 작동하지 않는다면 부모 요소의 CSS 설정 문제 가능성

**개선 방안**:
1. 부모 요소의 `user-select: none` 설정 확인 및 제거
2. 전역 CSS에서 Input/Textarea 관련 스타일 확인
3. React 컴포넌트의 `onSelect` 이벤트 핸들러 확인 (드래그 방지 로직 제거)
4. 브라우저 호환성 확인 (Chrome, Firefox, Safari)
5. 실제 동작 테스트 및 수정

**예상 파일**:
- `client/src/components/ui/input.tsx` (라인 1-38)
- `client/src/components/ui/textarea.tsx` (라인 1-38)
- `client/src/index.css` (전역 스타일)

**기대 효과**: 사용자 편의성 향상, 텍스트 복사/붙여넣기 기능 정상화

---

### Phase 3: UX 개선 및 추가 기능 (3주)

#### 10단계: 검색 기능 개선
**목표**: 최상단 검색 필드에서 키워드 검색 정확도 향상

**현황 분석**:
- `client/src/components/layout/topbar.tsx`에서 검색 로직 구현
- 단어 단위 매칭 로직 존재하지만 '호출' 검색 시 'API 호출 관리' 결과가 나오지 않음
- 부분 문자열 매칭이 제대로 작동하지 않을 수 있음

**개선 방안**:
1. 검색 알고리즘 개선: 부분 문자열 매칭 강화
2. 대소문자 구분 없음 확인
3. 한글/영문 혼합 검색 지원
4. 검색어 초기화 로직 추가 (검색 창 닫을 때)
5. 검색 결과 하이라이트 표시

**예상 파일**:
- `client/src/components/layout/topbar.tsx` (라인 159-199)

**기대 효과**: 검색 정확도 향상, 사용자 만족도 개선

---

#### 11단계: 금융 AI 어시스턴트 응답 형식 개선
**목표**: "PER뜻은 뭐야?" 질문 시 getTermDefinition("PER")만 응답하는 문제 해결

**현황 분석**:
- `server/routes/ai-chat.ts`의 `getTermDefinition()` 함수가 결과를 반환
- AI 응답 형식에서 도구 결과를 자연스럽게 포함하는 로직 필요
- 입력창 포커스 문제: 다시 질문하려면 입력창 클릭 필요

**개선 방안**:
1. AI 응답에서 도구 결과를 자연스럽게 통합
2. 응답 형식 개선: "PER은 ..." 형태로 자연스러운 응답 생성
3. 입력창 자동 포커스: 응답 완료 후 입력창에 자동 포커스
4. 엔터 키로 다음 질문 가능하도록 개선

**예상 파일**:
- `server/routes/ai-chat.ts` (라인 19-87)
- `client/src/pages/financial-chatbot.tsx` (라인 96-803)

**기대 효과**: 사용자 경험 개선, 자연스러운 대화 흐름 구현

---

#### 12단계: 알림창 자동 닫기 기능 추가
**목표**: 알림창이 일정 시간 후 자동으로 닫히도록 개선

**현황 분석**:
- 현재 알림창이 수동으로만 닫힘
- 사용자가 직접 닫아야 하는 번거로움

**개선 방안**:
1. Toast 컴포넌트에 자동 닫기 옵션 추가
2. 기본 자동 닫기 시간 설정 (예: 5초)
3. 에러 알림은 자동 닫기 시간 길게 설정 (예: 10초)
4. 사용자가 알림창에 마우스 오버 시 자동 닫기 일시 중지

**예상 파일**:
- `client/src/components/ui/toast.tsx`
- `client/src/hooks/use-toast.ts`

**기대 효과**: 사용자 편의성 향상, UI 깔끔함 유지

---

#### 13단계: AI SEARCH 관리 모듈 추가
**목표**: AI SEARCH 관리 모듈 신규 구현

**요구사항**:
- 인덱스 생성, 관리
- 인덱서 생성, 관리
- 데이터소스 연결 관리
- 데이터조회 인터페이스

**개선 방안**:
1. 데이터베이스 스키마 설계 (indices, indexers, data_sources 테이블)
2. API 엔드포인트 구현 (생성, 조회, 수정, 삭제)
3. 프론트엔드 페이지 구현 (`client/src/pages/ai-search-management.tsx`)
4. 인덱스 생성/관리 UI 구현
5. 인덱서 생성/관리 UI 구현
6. 데이터소스 연결 관리 UI 구현
7. 데이터 조회 인터페이스 구현

**예상 파일**:
- `shared/schema.ts` (스키마 추가)
- `server/routes.ts` (API 엔드포인트 추가)
- `server/storage.ts` (Storage 메서드 추가)
- `client/src/pages/ai-search-management.tsx` (신규 파일)

**기대 효과**: AI 검색 기능 확장, 시스템 기능성 향상

---

## 기대 효과 설명

### 정량적 효과
1. **에러율 감소**: 500 에러 10건 → 0건, 404 에러 5건 → 0건
2. **기능 성공률 향상**: 테마 생성/수정 0% → 100%, 워크플로우 실행 70% → 95%
3. **사용자 만족도**: 검색 정확도 60% → 90%, UI 응답성 향상

### 정성적 효과
1. **시스템 안정성**: 크리티컬 에러 해결로 시스템 안정성 향상
2. **사용자 경험**: 텍스트 선택, 드래그 기능 개선으로 편의성 향상
3. **확장성**: AI SEARCH 관리 모듈 추가로 시스템 기능 확장

---

## 우선순위 및 일정

### Phase 1: 크리티컬 에러 수정 (1주)
- 1단계: 스케줄러 시작 500 에러 (1일)
- 2단계: Dictionary Foreign Key 위반 (1일)
- 3단계: 워크플로우 AI 분석 노드 실행 실패 (1일)
- 4단계: 워크플로우 노드 타입 미지원 오류 (1일)
- 5단계: API 호출 관리 404 에러 (1일)

### Phase 2: 주요 기능 개선 (2주)
- 6단계: 테마 클러스터 관리 생성/수정 (3일)
- 7단계: 워크플로우 노드 입력/출력 형식 저장 (2일)
- 8단계: 종료 노드 Databricks 저장 (3일)
- 9단계: TextInput 드래그/선택 기능 (2일)

### Phase 3: UX 개선 및 추가 기능 (3주)
- 10단계: 검색 기능 개선 (2일)
- 11단계: 금융 AI 어시스턴트 응답 형식 (2일)
- 12단계: 알림창 자동 닫기 (1일)
- 13단계: AI SEARCH 관리 모듈 (10일)

---

## 추가 개선 사항 (참고)

### 테스트에서 발견된 기타 이슈
1. **프롬프트 빌더**: 테이블 스키마 조회 시 테이블 없음 에러 → 테이블 존재 여부 확인 로직 추가
2. **OpenAI 프로바이더**: 연결 테스트 실패 → API 키 및 엔드포인트 확인 로직 강화
3. **Azure 서비스 설정**: 커스텀 서비스 추가 후 UI에 표시 안됨 → 리스트 새로고침 로직 추가
4. **AI 시황 생성 테스트**: WebSocket 연결 실패 → WebSocket 서버 설정 확인
5. **개인화 대시보드**: 설정 버튼 반응 없음 → 이벤트 핸들러 확인
6. **매매 이력 분석**: useToast is not defined → import 확인
7. **관심 종목 관리**: 종목 추가 오류 → 데이터 검증 강화
8. **개인화 설정**: 프로필 저장 실패 → API 엔드포인트 확인
9. **ETF 투자가이드 상담**: 세션 시작 실패 → 사용자 프로필 초기화 로직 추가
10. **워크플로우 편집기**: SQL 쿼리 노드 드래그 시 쿼리 ID 미설정 → 드래그 시 기본값 설정

---

## 결론

본 수정 작업 계획서는 테스트 결과를 바탕으로 체계적으로 정리되었습니다. Phase 1의 크리티컬 에러 수정을 최우선으로 진행하고, 이후 Phase 2, Phase 3를 순차적으로 진행하는 것을 권장합니다.

각 단계별로 테스트를 진행하며, 수정 사항을 검증하고 다음 단계로 진행하는 것이 안전합니다.

**이 방향에 대해 어떻게 생각하시나요?**

